<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Jujutsu: Stone & Battle Loop</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; text-align: center; }
        .scene { display: none; width: 800px; height: 550px; margin: 10px auto; border: 4px solid #333; position: relative; background: #0a0a0f; }
        .active { display: flex; flex-direction: column; }
        
        /* å…±é€šUI */
        .status-header { background: #222; padding: 10px; display: flex; justify-content: space-around; font-weight: bold; }
        .ishi-count { color: #f1c40f; font-size: 20px; }
        .menu-btn { padding: 12px 25px; margin: 10px; cursor: pointer; background: #e74c3c; border: none; color: white; border-radius: 5px; }

        /* ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ */
        .character-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; }
        .char-card { border: 2px solid #444; padding: 10px; background: #222; cursor: pointer; border-radius: 5px; }
        .char-card.selected { border-color: #00d4ff; background: #003344; }

        /* ãƒãƒˆãƒ« */
        #battle-field { height: 320px; position: relative; background: #111; border-bottom: 2px solid #444; }
        .unit { position: absolute; transition: 0.3s; width: 100px; }
        .bar-container { width: 80px; height: 6px; background: #333; margin: 2px auto; border-radius: 3px; overflow: hidden; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: 0.3s; }
        .mp-fill { height: 100%; background: #00d4ff; width: 0%; transition: 0.3s; }
        
        #ui-bottom { height: 200px; background: #1a1a1a; display: grid; grid-template-columns: repeat(3, 1fr) 120px; gap: 10px; padding: 10px; }
    </style>
</head>
<body>

    <div class="status-header">
        <div>å‘ªè¡“é«˜å°‚ ç®¡ç†ç”»é¢</div>
        <div class="ishi-count">æ‰€æŒã‚¤ã‚·: <span id="ishi-val">5</span> å€‹</div>
    </div>

    <div id="scene-lobby" class="scene active">
        <h1>ãƒ­ãƒ“ãƒ¼</h1>
        <div style="margin-top: 100px;">
            <button class="menu-btn" onclick="changeScene('scene-gacha')">ã‚¬ãƒãƒ£ (1å€‹æ¶ˆè²»)</button>
            <button class="menu-btn" onclick="changeScene('scene-party')">ãƒãƒ¼ãƒ ç·¨æˆ</button>
            <button class="menu-btn" style="background:#2ecc71;" onclick="startBattle()">ä»»å‹™é–‹å§‹ (å‹åˆ©ã§1å€‹ç²å¾—)</button>
        </div>
    </div>

    <div id="scene-gacha" class="scene">
        <button onclick="changeScene('scene-lobby')">æˆ»ã‚‹</button>
        <h2>ç‰¹ç´šã‚¬ãƒãƒ£</h2>
        <div id="gacha-res" style="font-size: 80px; margin: 40px;">ï¼Ÿ</div>
        <button class="menu-btn" onclick="pullGacha()">ã‚¤ã‚·ã‚’1å€‹ä½¿ã£ã¦å¼•ã</button>
    </div>

    <div id="scene-party" class="scene">
        <button onclick="changeScene('scene-lobby')">æˆ»ã‚‹</button>
        <h2>ãƒãƒ¼ãƒ ç·¨æˆ (3äººé¸æŠ)</h2>
        <div id="my-chars" class="character-list"></div>
    </div>

    <div id="scene-battle" class="scene">
        <div id="battle-field">
            <div id="boss" class="unit" style="top:40px; right:80px; scale:1.4;">
                <div class="bar-container"><div id="hp-e" class="hp-fill"></div></div>
                <div style="font-size:60px">ğŸŒ‹</div>
            </div>
            <div id="p-units"></div>
        </div>
        <div id="ui-bottom">
            <div id="cmd-0"></div><div id="cmd-1"></div><div id="cmd-2"></div>
            <button id="go-btn" style="background:#e74c3c; color:white; border:none;" onclick="runBattleTurn()">ç¥“æ‰•</button>
        </div>
    </div>

<script>
    const allChars = [
        { id: 'i', name: 'è™æ–', emoji: 'ğŸ¤œ', hp: 150 },
        { id: 'g', name: 'äº”æ¡', emoji: 'ğŸ˜', hp: 400 },
        { id: 'f', name: 'ä¼é»’', emoji: 'ğŸº', hp: 120 },
        { id: 'n', name: 'ä¸ƒæµ·', emoji: 'ğŸ“', hp: 140 }
    ];

    let ishi = 5;
    let inventory = ['i']; // æœ€åˆã¯è™æ–ã®ã¿
    let party = [];
    let battleUnits = []; // ãƒãƒˆãƒ«ä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨
    let bossHP = 1000;

    function updateIshi() { document.getElementById('ishi-val').innerText = ishi; }

    function changeScene(id) {
        document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'scene-party') renderParty();
    }

    // --- ã‚¬ãƒãƒ£ ---
    function pullGacha() {
        if(ishi < 1) return alert("ã‚¤ã‚·ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
        ishi--; updateIshi();
        const res = allChars[Math.floor(Math.random()*allChars.length)];
        document.getElementById('gacha-res').innerText = res.emoji;
        if(!inventory.includes(res.id)) inventory.push(res.id);
    }

    // --- ç·¨æˆ ---
    function renderParty() {
        const list = document.getElementById('my-chars');
        list.innerHTML = '';
        inventory.forEach(id => {
            const data = allChars.find(c => c.id === id);
            const card = document.createElement('div');
            card.className = `char-card ${party.includes(id) ? 'selected' : ''}`;
            card.innerHTML = `<div style="font-size:30px">${data.emoji}</div>${data.name}`;
            card.onclick = () => {
                if(party.includes(id)) party = party.filter(p => p !== id);
                else if(party.length < 3) party.push(id);
                renderParty();
            };
            list.appendChild(card);
        });
    }

    // --- ãƒãƒˆãƒ« ---
    function startBattle() {
        if(party.length === 0) return alert("ç·¨æˆã§ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
        bossHP = 1000;
        battleUnits = party.map(id => {
            const data = allChars.find(c => c.id === id);
            return { ...data, curHP: data.hp, mp: 0 };
        });
        
        changeScene('scene-battle');
        renderBattle();
    }

    function renderBattle() {
        const field = document.getElementById('p-units');
        field.innerHTML = '';
        battleUnits.forEach((u, i) => {
            field.innerHTML += `
                <div id="u-${i}" class="unit" style="bottom:${100 - i*30}px; left:${60 + i*110}px;">
                    <div class="bar-container"><div id="hp-p${i}" class="hp-fill" style="width:${u.curHP/u.hp*100}%"></div></div>
                    <div class="bar-container"><div id="mp-p${i}" class="mp-fill" style="width:${u.mp}%"></div></div>
                    <div style="font-size:50px">${u.emoji}</div>
                </div>`;
            document.getElementById(`cmd-${i}`).innerHTML = `
                <div style="font-size:12px">${u.name}</div>
                <select id="sel-${i}">
                    <option value="atk">å‘ªæ’ƒ (+20MP)</option>
                    <option value="skill" ${u.mp < 50 ? 'disabled' : ''}>è¡“å¼ (50MP)</option>
                </select>`;
        });
        document.getElementById('hp-e').style.width = (bossHP/10) + "%";
    }

    async function runBattleTurn() {
        document.getElementById('go-btn').disabled = true;
        for(let i=0; i<battleUnits.length; i++) {
            const u = battleUnits[i];
            const move = document.getElementById(`sel-${i}`).value;
            let dmg = 0;

            if(move === 'atk') {
                dmg = 40; u.mp = Math.min(100, u.mp + 20);
            } else {
                dmg = 150; u.mp -= 50;
            }
            
            bossHP = Math.max(0, bossHP - dmg);
            document.getElementById(`u-${i}`).style.transform = "translateX(40px)";
            renderBattle();
            await new Promise(r => setTimeout(r, 400));
            document.getElementById(`u-${i}`).style.transform = "";
        }

        if(bossHP <= 0) {
            alert("å‹åˆ©ï¼ã‚¤ã‚·ã‚’1å€‹ç²å¾—ã—ã¾ã—ãŸï¼");
            ishi++; updateIshi();
            changeScene('scene-lobby');
        } else {
            alert("æ•µã®æ”»æ’ƒï¼å…¨å“¡ã«20ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
            battleUnits.forEach(u => u.curHP = Math.max(0, u.curHP - 20));
            renderBattle();
        }
        document.getElementById('go-btn').disabled = false;
    }
</script>
</body>
</html>
