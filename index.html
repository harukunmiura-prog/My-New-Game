<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MARU VS MOCHI - 5on5 TOTAL WAR (Final Edition)</title>
    <style>
        :root { --primary: #00ffcc; --accent: #ff0055; --bg: #05050a; }
        body { 
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif; 
            background: var(--bg); color: #fff; margin: 0; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(rgba(0, 255, 204, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 204, 0.1) 1px, transparent 1px);
            background-size: 50px 50px; perspective: 500px; transform: rotateX(60deg); animation: move-bg 5s linear infinite;
        }
        @keyframes move-bg { from { background-position: 0 0; } to { background-position: 0 50px; } }

        .screen { display: none; width: 100%; max-width: 1200px; padding: 10px; flex-direction: column; align-items: center; }
        .visible { display: flex; }

        /* „Ç≠„É£„É©ÈÅ∏Êäû */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .sel-card { 
            background: rgba(255,255,255,0.05); border: 2px solid #444; padding: 12px; border-radius: 12px; 
            cursor: pointer; text-align: center; transition: 0.2s; position: relative;
        }
        .sel-card:hover { border-color: var(--primary); background: rgba(0,255,204,0.05); }
        .sel-card.selected { border-color: var(--primary); box-shadow: 0 0 15px var(--primary); background: rgba(0,255,204,0.1); }
        .char-role { font-size: 0.7em; color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block; }
        .char-desc { font-size: 0.75em; color: #ccc; margin-top: 5px; height: 3em; line-height: 1.2; }

        /* „Éï„Ç£„Éº„É´„Éâ */
        .field { display: flex; width: 100%; justify-content: space-between; gap: 20px; margin-top: 10px; }
        .team { display: flex; flex-direction: column; gap: 10px; width: 48%; }
        
        .card { 
            background: rgba(0,0,0,0.85); border: 2px solid #555; border-radius: 10px; padding: 10px; 
            position: relative; transition: 0.3s; font-size: 0.9em;
        }
        .card.active-now { border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.02); z-index: 10; }
        .card.acted { opacity: 0.5; border-color: #222; }
        .card.targetable { border-color: #ffeb3b; cursor: crosshair; animation: target-glow 0.8s infinite; }
        @keyframes target-glow { 0%, 100% { box-shadow: 0 0 5px #ffeb3b; } 50% { box-shadow: 0 0 20px #ffeb3b; } }
        .card.dead { opacity: 0.1; filter: grayscale(1); pointer-events: none; }

        .bar-container { background: #111; height: 12px; border-radius: 6px; border: 1px solid #333; overflow: hidden; margin: 5px 0; }
        .hp-fill { background: linear-gradient(90deg, #00f260, #0575e6); height: 100%; transition: 0.4s; }
        .en-fill { height: 3px; background: #2196f3; transition: 0.3s; }

        .skill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 5px; }
        .s-btn { 
            background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 5px 2px; border-radius: 4px; 
            font-size: 0.75em; cursor: pointer; position: relative;
        }
        .s-btn:hover:not(:disabled) { border-color: var(--primary); }
        .s-btn:disabled { opacity: 0.2; }
        .s-btn.cooldown { color: #555; }
        
        /* „Çπ„Ç≠„É´Ë™¨Êòé„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
        .s-btn::after {
            content: attr(data-tip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; border: 1px solid var(--primary); padding: 5px; border-radius: 4px;
            font-size: 0.8em; visibility: hidden; width: 120px; z-index: 1000; pointer-events: none;
        }
        .s-btn:hover::after { visibility: visible; }

        .log { width: 100%; height: 80px; background: rgba(0,0,0,0.9); margin-top: 10px; padding: 10px; border: 1px solid #333; overflow-y: auto; font-size: 0.85em; border-radius: 8px; }
        .dmg-pop { position: absolute; top: 0; left: 50%; color: #ff4444; font-size: 2.5em; font-weight: bold; animation: fadeUp 0.8s forwards; text-shadow: 2px 2px #000; pointer-events: none; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -60px); } }
    </style>
</head>
<body>
    <div class="grid-bg"></div>

    <div id="lobby" class="screen visible">
        <h1 style="color: var(--primary); font-size: 3em; margin: 10px; text-shadow: 0 0 10px var(--primary);">5 VS 5 TOTAL WAR</h1>
        <p>ÊúÄÂº∑„ÅÆ5‰∫∫„ÇíÈÅ∏„ÅπÔºÅÊäÄ„Å´„Éû„Ç¶„Çπ„ÇíÂêà„Çè„Åõ„Çã„Å®Ë©≥Á¥∞„ÅåË¶ã„Çå„Çã„Åû„ÄÇ</p>
        <div id="char-selection" class="char-grid"></div>
        <button onclick="startGame()" style="padding: 15px 80px; font-size: 1.2em; border-radius: 40px; background: var(--primary); border: none; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px var(--primary);">BATTLE START</button>
    </div>

    <div id="battle" class="screen">
        <div id="turn-txt" style="font-size: 1.5em; font-weight: bold; text-shadow: 0 0 10px var(--primary);">READY</div>
        <div class="field">
            <div class="team" id="p-team"></div>
            <div class="team" id="e-team"></div>
        </div>
        <div class="log" id="log"></div>
    </div>

<script>
    function speak(txt) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'ja-JP'; u.rate = 1.6; window.speechSynthesis.speak(u); }

    const MASTER = [
        { name: "„Åä„Åæ„Çã", role: "„Ç¢„Çø„ÉÉ„Ç´„Éº", desc: "È´òÁÅ´Âäõ„ÅÆÂçò‰Ωì„ÉªÂÖ®‰ΩìÊîªÊíÉ„ÇíÊåÅ„Å§Ê®ôÊ∫ñÊ©ü", hp: 1500, skills: [{n:"Á™ÅË≤´", cost:5, dmg:350, t:"single", d:"Âçò‰Ωì350„ÉÄ„É°„Éº„Ç∏"}, {n:"Ëá™Ëª¢", cost:10, dmg:150, t:"all", d:"ÂÖ®‰Ωì150„ÉÄ„É°„Éº„Ç∏"}, {n:"Áõæ", cost:10, shield:400, t:"self", d:"Ëá™ÂàÜ„Å´Áõæ400"}]},
        { name: "„É¢„ÉÅ(Êà¶)", role: "„Ç¨„Éº„Éâ„Éä„Éº", desc: "„ÉÅ„Éº„É†„ÇíÂÆà„Çä„Å§„Å§Áõæ„ÇíÁ†¥Â£ä„Åô„ÇãÁâπÊîªÈöäÈï∑", hp: 1300, skills: [{n:"ÁÑº„ÅçÈ§Ö", cost:10, dmg:200, t:"all", d:"ÂÖ®‰Ωì200„ÉÄ„É°„Éº„Ç∏"}, {n:"‰∏∏È§Ö", cost:8, shield:250, t:"team", d:"ÂÖ®Âì°„Å´Áõæ250"}, {n:"ÁõæÁ†ï„Åç", cost:15, dmg:150, break:true, t:"single", d:"ÁõæÁ†¥Â£äÔºãÊîªÊíÉ"}]},
        { name: "„É¢„ÉÅ(Èò≤)", role: "„Çø„É≥„ÇØ", desc: "È´ò„ÅÑËÄê‰πÖÂäõ„Å®Â¶®ÂÆ≥„Çπ„Ç≠„É´„ÅßÊà¶Á∑ö„ÇíÁ∂≠ÊåÅ", hp: 2000, skills: [{n:"Êäï„Åí", cost:5, dmg:100, t:"single", d:"Âçò‰Ωì100„ÉÄ„É°„Éº„Ç∏"}, {n:"Áô∫Èõª", cost:12, heal:450, t:"self", d:"Ëá™ÂàÜ„Çí450ÂõûÂæ©"}, {n:"Ê•µÊÑè", cost:18, stun:1, t:"single", d:"1T„Çπ„Çø„É≥‰ªò‰∏é"}]},
        { name: "„Åä„Åæ„Çã(ÁÑ°)", role: "„Éú„Çπ", desc: "3TÂæå„Å´Ëá™ÊªÖ„Åô„Çã„Åå„ÄÅÂúßÂÄíÁöÑ„Å™ÁÅ´Âäõ„ÇíË™á„Çã", hp: 3500, limit: 3, skills: [{n:"Fever", cost:10, dmg:550, t:"single", d:"Âçò‰Ωì550„ÉÄ„É°„Éº„Ç∏"}, {n:"ÊâãÂàÄ", cost:10, dmg:200, t:"single", d:"Âçò‰Ωì200„ÉÄ„É°„Éº„Ç∏"}, {n:"ÁÑ°Èôê", cost:30, stun:3, t:"single", d:"Âº∑Âäõ„Å™3T„Çπ„Çø„É≥"}]},
        { name: "„É¢„ÉÅ(ÁÑ°Èôê)", role: "„ÉÜ„ÇØ„Éã„Ç´„É´", desc: "„Çπ„Çø„É≥„Å®„Ç∑„Éº„É´„Éâ„Åß„Éà„É™„ÉÉ„Ç≠„Éº„Å´Êà¶„ÅÜ", hp: 1400, skills: [{n:"ÂâµÈÄ†", cost:5, dmg:150, t:"single", d:"Âçò‰Ωì150„ÉÄ„É°„Éº„Ç∏"}, {n:"ÊÄùÁ¥¢", cost:12, shield:400, t:"self", d:"Ëá™ÂàÜ„Å´Áõæ400"}, {n:"ÂãòÊ°à", cost:20, stun:2, t:"single", d:"2T„Çπ„Çø„É≥‰ªò‰∏é"}]},
        { name: "„Åä„Åæ„Çã(„ÉÅ„Éß„Ç≥)", role: "„Çµ„Éù„Éº„Çø„Éº", desc: "Âë≥Êñπ„ÅÆEN„ÇíÂõûÂæ©„Åï„Åõ„Çã„ÉÅ„Éº„É†„ÅÆË¶Å", hp: 1200, skills: [{n:"„Ç±„Éº„Ç≠", cost:10, en:45, t:"ally", d:"Âë≥Êñπ„ÅÆEN+45"}, {n:"„Éô„Éº„Ç≥„É≥", cost:15, dmg:130, t:"all", d:"ÂÖ®‰Ωì130„ÉÄ„É°„Éº„Ç∏"}, {n:"‰æµÁï•", cost:8, en:20, t:"team", d:"ÂÖ®Âì°„ÅÆEN+20"}]},
        { name: "„ÇÇ„Å°(Âºì)", role: "„Çπ„Éä„Ç§„Éë„Éº", desc: "‰ΩéÁáÉË≤ª„ÅÆÂçò‰ΩìÊîªÊíÉ„Å®ÂÖ®‰ΩìÊîªÊíÉ„Çí‰Ωø„ÅÑÂàÜ„Åë„Çã", hp: 1100, skills: [{n:"ÁãôÊíÉ", cost:5, dmg:250, t:"single", d:"Âçò‰Ωì250„ÉÄ„É°„Éº„Ç∏"}, {n:"‰π±„ÇåÊâì", cost:15, dmg:100, t:"all", d:"ÂÖ®‰Ωì100„ÉÄ„É°„Éº„Ç∏"}, {n:"ÈõÜ‰∏≠", cost:10, en:30, t:"self", d:"Ëá™ÂàÜ„ÅÆEN+30"}]},
        { name: "„Åä„Åæ„Çã(Ââ£)", role: "„ÇΩ„É´„Ç∏„É£„Éº", desc: "‰∏ÄÊíÉ„ÅÆÈáç„Åï„Å®Èò≤Âæ°„ÅÆ„Éê„É©„É≥„Çπ„ÅåËâØ„ÅÑ", hp: 1600, skills: [{n:"‰∏ÄÈñÉ", cost:10, dmg:400, t:"single", d:"Âçò‰Ωì400„ÉÄ„É°„Éº„Ç∏"}, {n:"ÂÜÜÊúà", cost:10, dmg:120, t:"all", d:"ÂÖ®‰Ωì120„ÉÄ„É°„Éº„Ç∏"}, {n:"Êßã„Åà", cost:5, shield:200, t:"self", d:"Ëá™ÂàÜ„Å´Áõæ200"}]}
    ];

    let state = { turn: 'player', p: [], e: [], pendingS: null, attacker: null, locking: false, pActedCount: 0 };

    const grid = document.getElementById('char-selection');
    MASTER.forEach((c, i) => {
        const d = document.createElement('div');
        d.className = 'sel-card';
        d.innerHTML = `<span class="char-role">${c.role}</span><strong>${c.name}</strong><br><small>HP:${c.hp}</small><div class="char-desc">${c.desc}</div>`;
        d.onclick = () => {
            if(state.p.some(x => x.id === i)) { state.p = state.p.filter(x => x.id !== i); d.classList.remove('selected'); }
            else if(state.p.length < 5) { state.p.push({...JSON.parse(JSON.stringify(c)), id: i}); d.classList.add('selected'); }
        };
        grid.appendChild(d);
    });

    function startGame() {
        if(state.p.length < 5) return alert("5‰ΩìÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ");
        state.p = state.p.map(c => ({...c, maxHp: c.hp, energy: 20, shield: 0, stunned: 0, lastSkill: -1, acted: false}));
        state.e = MASTER.slice(0, 5).map((c, i) => ({...JSON.parse(JSON.stringify(c)), maxHp: c.hp, energy: 20, shield: 0, stunned: 0, lastSkill: -1, acted: false, id: i+100}));
        document.getElementById('lobby').classList.remove('visible');
        document.getElementById('battle').classList.add('visible');
        speak("Á∑èÂäõÊà¶ÈñãÂßãÔºÅ");
        render();
    }

    function render() {
        renderT('p-team', state.p, false);
        renderT('e-team', state.e, true);
        const txt = document.getElementById('turn-txt');
        txt.textContent = state.turn === 'player' ? `PLAYER TURN (${5-state.pActedCount}‰∫∫ÊÆã)` : 'ENEMY TURN...';
    }

    function renderT(id, team, isE) {
        const container = document.getElementById(id);
        container.innerHTML = '';
        team.forEach((c, i) => {
            const card = document.createElement('div');
            card.className = `card ${c.hp <= 0 ? 'dead' : ''} ${state.attacker === c ? 'active-now' : ''} ${!isE && c.acted ? 'acted' : ''}`;
            card.id = `${isE?'e':'p'}-${i}`;
            if(state.pendingS && isE && c.hp > 0 && state.pendingS.t === "single") { card.classList.add('targetable'); card.onclick = () => exec(c); }
            if(state.pendingS && !isE && c.hp > 0 && state.pendingS.t === "ally" && c !== state.attacker) { card.classList.add('targetable'); card.onclick = () => exec(c); }

            card.innerHTML = `
                ${c.shield > 0 ? `<div style="position:absolute;top:-8px;right:-8px;background:#00d2ff;color:#000;padding:2px 6px;border-radius:10px;font-weight:bold;font-size:0.7em;box-shadow:0 0 5px #00d2ff;">üõ°Ô∏è${c.shield}</div>` : ''}
                <strong style="color:var(--primary)">${c.name}</strong> ${c.stunned ? 'üí§' : ''}
                <div class="bar-container"><div class="hp-fill" style="width:${(c.hp/c.maxHp)*100}%"></div></div>
                <div class="en-fill" style="width:${c.energy}%"></div>
                <div class="skill-grid">
                    ${c.skills.map((s, si) => `<button class="s-btn ${c.lastSkill===si?'cooldown':''}" data-tip="${c.lastSkill===si?'„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥':s.d}" onclick="prep(${i}, ${si})" ${isE || c.energy < s.cost || c.stunned || state.turn !== 'player' || state.locking || c.acted || c.lastSkill===si ? 'disabled' : ''}>${s.n}</button>`).join('')}
                </div>
            `;
            container.appendChild(card);
        });
    }

    window.prep = function(ci, si) {
        if(state.locking) return;
        const a = state.p[ci]; const s = a.skills[si];
        state.attacker = a; state.pendingS = s;
        if(["all", "team", "self"].includes(s.t)) exec(null);
        else render();
    }

    function exec(target) {
        state.locking = true;
        const a = state.attacker; const s = state.pendingS;
        a.energy -= s.cost;
        a.lastSkill = a.skills.findIndex(sk => sk.n === s.n);
        a.acted = true;
        
        speak(a.name + "„ÄÅ" + s.n);
        addLog(a.name + "„ÅÆ" + s.n);
        render();

        setTimeout(() => {
            const opT = state.p.includes(a) ? state.e : state.p;
            const myT = state.p.includes(a) ? state.p : state.e;

            if(s.dmg) { (s.t === "all" ? opT : [target]).forEach(t => { if(!t || t.hp <= 0) return; if(s.break) t.shield = 0; let d = s.dmg; if(t.shield >= d) { t.shield -= d; d = 0; } else { d -= t.shield; t.shield = 0; } t.hp -= d; showD(t, d); }); }
            if(s.shield) { (s.t==="team"?myT:[a]).forEach(t => t.shield += s.shield); }
            if(s.heal) { (s.t==="team"?myT:[a]).forEach(t => t.hp = Math.min(t.maxHp, t.hp + s.heal)); }
            if(s.stun && target) target.stunned = Math.max(target.stunned, s.stun);
            if(s.en && target) target.energy = Math.min(100, target.energy + s.en);

            state.pendingS = null; state.attacker = null;
            
            if(state.turn === 'player') {
                state.pActedCount++;
                state.locking = false;
                const canAct = state.p.filter(p=>p.hp>0 && !p.stunned && !p.acted).length;
                if(canAct === 0) {
                    state.turn = 'enemy';
                    setTimeout(enemyPhase, 1000);
                } else { render(); }
            } else {
                render();
            }
            checkGameEnd();
        }, 600);
    }

    async function enemyPhase() {
        const attackers = state.e.filter(e => e.hp > 0 && !e.stunned);
        for(let a of attackers) {
            if(state.p.every(p => p.hp <= 0)) break;
            state.attacker = a;
            const targetP = state.p.filter(p => p.hp > 0).sort((x,y) => x.hp - y.hp)[0];
            let possible = a.skills.filter((s, idx) => s.cost <= a.energy && idx !== a.lastSkill);
            let s = possible.sort((x,y) => (y.dmg||0) - (x.dmg||0))[0] || a.skills[0];
            state.pendingS = s;
            exec(s.t === "self" ? a : targetP);
            await new Promise(r => setTimeout(r, 1400));
        }
        state.turn = 'player';
        nextTurnProcess();
    }

    function nextTurnProcess() {
        [...state.p, ...state.e].forEach(c => {
            if(c.hp > 0) {
                c.energy = Math.min(100, c.energy + 15);
                if(c.stunned > 0) c.stunned--;
                c.acted = false;
                if(c.limit !== undefined) { c.limit--; if(c.limit <= 0) { c.hp = 0; speak(c.name + "„ÄÅÊ∂àÊªÖÔºÅ"); } }
            }
        });
        state.pActedCount = 0;
        state.locking = false;
        render();
    }

    function checkGameEnd() {
        if(state.e.every(e => e.hp <= 0)) { alert("VICTORY!"); location.reload(); }
        if(state.p.every(p => p.hp <= 0)) { alert("DEFEAT..."); location.reload(); }
    }

    function showD(t, d) {
        const isP = state.p.includes(t);
        const idx = isP ? state.p.indexOf(t) : state.e.indexOf(t);
        const el = document.getElementById(`${isP?'p':'e'}-${idx}`);
        if(el) {
            const p = document.createElement('div'); p.className = 'dmg-pop';
            p.textContent = d > 0 ? `-${d}` : "BLOCK";
            el.appendChild(p); setTimeout(() => p.remove(), 800);
        }
    }
    function addLog(m) { const l = document.getElementById('log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
</script>
</body>
</html>
